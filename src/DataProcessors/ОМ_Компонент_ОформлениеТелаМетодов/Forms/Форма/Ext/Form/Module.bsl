// Репозиторий проекта: 
// https://github.com/vladimir-kharin/1c_formatter
// 
// Харин Владимир (С) 2025. https://vharin.ru
// Telegram - https://t.me/vladimir_kharin

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если Параметры.Свойство("ПараметрыКоманды") Тогда
		АдресДереваСтруктурыМодулей = Параметры.ПараметрыКоманды.АдресДереваСтруктурыМодулей;
		дз = ПолучитьИзВременногоХранилища(АдресДереваСтруктурыМодулей);
		Если Параметры.ПараметрыКоманды.Идентификатор = "ОформлениеМетодаСНастройкой" Тогда
			дз.Колонки.Добавить("НомерСтрокиВМетодыКОформлению");
			
			ВыбраннаяСтрока = Обработки.ОМ_ОформляторМодулей.НайтиВыбраннуюСтроку(дз);
			
			МассивМетодов = Новый Массив;
			Если ВыбраннаяСтрока.ТипЭлемента = "Процедура" ИЛИ ВыбраннаяСтрока.ТипЭлемента = "Функция" Тогда
				МассивМетодов.Добавить(ВыбраннаяСтрока);
			ИначеЕсли ВыбраннаяСтрока.ТипЭлемента = "Область" ИЛИ ВыбраннаяСтрока.ТипЭлемента = "Модуль" Тогда
				МассивМетодов = Обработки.ОМ_ОформляторМодулей.НайтиПодчиненныеСтроки(ВыбраннаяСтрока, "Процедура,Функция");
			КонецЕсли;
			
			ОдинМетод = (МассивМетодов.Количество() = 1);
			
			НомерСтроки = 1;
			Для каждого СтрМетод Из МассивМетодов Цикл
				Метод = МетодыКОформлению.Добавить();
				ЗаполнитьЗначенияСвойств(Метод, СтрМетод.Содержимое, "Имя,ЭтоФункция,Тело");
				Метод.Пометка = Истина;
				Метод.НомерКартинки = ?(Метод.ЭтоФункция, 1, 0);
				
				СтрМетод.НомерСтрокиВМетодыКОформлению = НомерСтроки;
				НомерСтроки = НомерСтроки + 1;
			КонецЦикла;
	
			ПоместитьВоВременноеХранилище(дз, АдресДереваСтруктурыМодулей);
			
			// Устанавливаем текущую страницу в зависимости от количества методов
			Элементы.СтраницыОдинНесколько.ТекущаяСтраница = ?(ОдинМетод,
				Элементы.СтраницаОдинМетод,
				Элементы.СтраницаНесколькоМетодов);
				
			Если Не ЗначениеЗаполнено(ПравилаОформления) Тогда
				ПравилаОформления =
				"- Приведи написание ключевых слов и стандартных методов платформы к каноническому виду (если/ЕСЛИ -> Если, тогда/ТОГДА - > Тогда, и так далее).
				|- Оформи отступы. Стандартный отступ - одна табуляция. Если отступы сделаны пробелами - переделай на табуляции.
				|- В одной строке кода должно быть не более одного оператора.";
			КонецЕсли;
		КонецЕсли;
	Иначе
		ВызватьИсключение "В форму должен быть передан параметр ПараметрыКоманды.АдресДереваСтруктурыМодулей";
	КонецЕсли;
	
	ПроверитьКодПослеОформления = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Элементы.МетодыКОформлению.ТекущаяСтрока = МетодыКОформлению[0].ПолучитьИдентификатор();
	УстановитьВидимостьДоступностьЭлементовФормы();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ПроверитьКодПослеОформленияПриИзменении(Элемент)
	УстановитьВидимостьДоступностьЭлементовФормы();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Оформить(Команда)
	Для каждого Метод Из МетодыКОформлению Цикл
		Если НЕ Метод.Пометка Тогда
			Продолжить;
		КонецЕсли;
		
		ТелоОформленное = ОформитьТело(Метод.Тело);
		МетодОформлен = Истина;
		Если ПроверитьКодПослеОформления Тогда
			Если ЕстьСущественныеОтличияКодаПослеОформления(Метод.Тело, ТелоОформленное) Тогда
				СообщениеОбОшибке = СтрШаблон("Метод %1 не может быть оформлен. См. лог", Метод.Имя);

				Сообщение = Новый СообщениеПользователю;
				Сообщение.Текст = СообщениеОбОшибке;
				Сообщение.Сообщить();

				МетодОформлен = Ложь;
			Иначе
				Метод.ТелоОформленное = ТелоОформленное;
			КонецЕсли;
		Иначе
			Метод.ТелоОформленное = ТелоОформленное;
		КонецЕсли;

		Если МетодыКОформлению.Количество() > 1 
			И МетодОформлен Тогда
			Метод.Пометка = Ложь;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ПринятьИЗакрыть(Команда)
	ПринятьИЗакрытьНаСервере();
	Закрыть(Новый Структура("АдресДереваСтруктурыМодулей", АдресДереваСтруктурыМодулей));
КонецПроцедуры

&НаКлиенте
Процедура УстановитьПометки(Команда)
	Для каждого МетодКОформлению Из МетодыКОформлению Цикл
		МетодКОформлению.Пометка = Истина;
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура СнятьПометки(Команда)
	Для каждого МетодКОформлению Из МетодыКОформлению Цикл
		МетодКОформлению.Пометка = Ложь;
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервереБезКонтекста
Функция ОформитьТело(ТелоМетода)
	Возврат Обработки.ОМ_Компонент_ОформлениеТелаМетодов.Оформить(ТелоМетода);
КонецФункции

&НаСервереБезКонтекста
Функция УпрощенноеДеревоРазбора(ТаблицаТокенов)
	МассивБлоков = Новый Массив;

	ВыделитьБлокиРекурсивно(ТаблицаТокенов, МассивБлоков);

	Возврат МассивБлоков;
КонецФункции

&НаСервереБезКонтекста
Функция ВыделитьБлокиРекурсивно(ТаблицаТокенов, МассивБлоков)
	Для каждого Токен Из ТаблицаТокенов Цикл
		Если Токен.Токен = "Метка" Тогда
			Блок = СоздатьБлокМетка(Токен);
			МассивБлоков.Добавить(Блок);
		КонецЕсли;
	КонецЦикла;

	Возврат Неопределено;
КонецФункции

&НаСервереБезКонтекста
Функция СоздатьБлокМетка(Токен)
	Блок = Новый Структура("Тип", "Метка");
	Блок.Метка = Токен.Содержимое;
	Возврат Блок;
КонецФункции

&НаКлиенте
Процедура УстановитьВидимостьДоступностьЭлементовФормы()
	Если ПроверитьКодПослеОформления Тогда
		Элементы.ПроверитьКодПослеОформления.ЦветТекстаЗаголовка = Элементы.Метод.ЦветТекстаЗаголовка;
		Элементы.ПравилаИзменения.Видимость = Ложь;
	Иначе
		Элементы.ПроверитьКодПослеОформления.ЦветТекстаЗаголовка = WebЦвета.Красный;
		Элементы.ПравилаИзменения.Видимость = Истина;
	КонецЕсли;
КонецПроцедуры

&НаСервереБезКонтекста
Функция ЕстьСущественныеОтличияКодаПослеОформления(ТелоДоОформления, ТелоОформленное)

	СущественныеОтличия = Обработки.ОМ_Компонент_ОформлениеТелаМетодов.ОписаниеСущественныхОтличийПоТокенам(ТелоДоОформления, ТелоОформленное);
	
	Если ЗначениеЗаполнено(СущественныеОтличия) Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = СущественныеОтличия;
		Сообщение.Сообщить();

		Возврат Истина;
	КонецЕсли;

	Возврат Ложь;
КонецФункции

&НаСервере
Процедура ПринятьИЗакрытьНаСервере()
	дз = ПолучитьИзВременногоХранилища(АдресДереваСтруктурыМодулей);
	
	Для Индекс = 0 По МетодыКОформлению.Количество() - 1 Цикл
		Метод = МетодыКОформлению[Индекс];
		
		// Находим строку метода в дереве по номеру строки
		СтрокиМетода = дз.Строки.НайтиСтроки(Новый Структура("НомерСтрокиВМетодыКОформлению", Индекс + 1), Истина);
		Если СтрокиМетода.Количество() = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаМетода = СтрокиМетода[0];
		
		// Обновляем параметры метода в дереве
		Если ЗначениеЗаполнено(Метод.ТелоОформленное) Тогда
			СтрокаМетода.Содержимое.Тело = Метод.ТелоОформленное;
		КонецЕсли;
	КонецЦикла;
	
	ПоместитьВоВременноеХранилище(дз, АдресДереваСтруктурыМодулей);
КонецПроцедуры

#КонецОбласти

